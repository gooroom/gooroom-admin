<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="PortableImageDAO">

    <resultMap type="portableImageVO" id="portableImage">

        <result property="imageId" column="IMAGE_ID" />
        <result property="name" column="NAME" />
        <result property="url" column="URL" />
        <result property="size" column="SIZE" />
        <result property="createdDt" column="CREATED_DT" />
        <result property="status" column="STATUS" />

    </resultMap>

    <resultMap type="portableImageViewVO" id="imageView">
        <result property="imageId" column="IMAGE_ID" />
        <result property="name" column="NAME" />
        <result property="createdDt" column="CREATED_DT" />
        <result property="size" column="SIZE" />
        <result property="status" column="STATUS" />
        <result property="userId" column="USER_ID" />
        <result property="regDt" column="REG_DT" />
    </resultMap>

    <select id="selectImageCount" resultType="java.lang.Integer">
        SELECT COUNT(*) CNT
        FROM PTGR_IMAGE
    </select>

    <select id="selectNextImageNo" resultType="java.lang.Integer">
        SELECT GRNEXTVAL('PTGRIMAGE_SEQ') AS IMAGE_ID FROM DUAL;
    </select>

    <!-- 포터블 이미지 정보 생성 -->
    <insert id="insertPortableImage" parameterType="portableImageVO">
        INSERT INTO PTGR_IMAGE
            (IMAGE_ID, NAME, CREATED_DT, URL, SIZE, STATUS)
        VALUES
            (#{imageId}, #{name}, #{createdDt}, #{url}, #{size}, #{status});
    </insert>

    <select id="selectPortableImageList" resultMap="imageView">
        SELECT *
        FROM VIEW_PTGR_IMAGE
        WHERE STATUS != 'REMOVE';
    </select>

    <select id="selectPortableImageListByCondition" parameterType="hashmap" resultMap="imageView">
        SELECT
            (IMAGE_ID, NAME, CREATED_DT, SIZE, STATUS, USER_ID, REG_DT)
        FROM VIEW_PTGR_IMAGE
        WHERE STATUS != 'REMOVE';
    </select>

    <!-- 이미지 파일 정보 업데이트 -->
    <update id="updatePortableImage" parameterType="portableImageVO">
        UPDATE PTGR_IMAGE
        SET
        <if test="name!= null">NAME = #{name},</if>
        <if test="url!= null">URL = #{url},</if>
        <if test="size!= null">SIZE = #{size},</if>
        <if test="status!= null">STATUS = #{status},</if>
        CREATED_DT = now()
        WHERE IMAGE_ID = #{imageId};
    </update>

    <!-- 이미지 상태 업데이트 (또는 상태 변경으로 삭제) -->
    <update id="updatePortableImageStatus" parameterType="hashMap">
        UPDATE PTGR_IMAGE
        SET STATUS = #{status}
        WHERE IMAGE_ID = #{imageId};
    </update>

    <!-- 이미지 삭제 -->
    <!--
        <delete id="deletePortableImage" parameterType="Integer">
            DELETE FROM PTGR_IMAGE
            WHERE IMAGE_ID = #{imageId};
        </delete>
        <delete id="deletePortableImage" parameterType="hashMap">
            DELETE FROM PTGR_IMAGE IN
            <foreach item="item" index="index" collection="imageIds" open="(" separator="," close=")">
                ${item}
            </foreach>
        </delete>
    -->
    <delete id="deletePortableImage" parameterType="hashmap">
        UPDATE PTGR_IMAGE
        SET STATUS = 'REMOVE'
        WHERE IMAGE_ID IN
        <foreach collection="imageIds" item="imageIds"  open="(" separator="," close=")">
            ${imageIds}
        </foreach>
    </delete>

    <delete id="deleteAllPortableImage">
        UPDATE PTGR_IMAGE
        SET IMAGE_STATUS = 'REMOVE'
    </delete>

</mapper>
